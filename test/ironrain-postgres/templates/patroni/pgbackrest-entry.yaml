---
# Source: ironrain-postgres/templates/patroni/pgbackrest-entry.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-pgbackrest-entrypoint
data:
  backup-schedule.py: |    
    #!/usr/bin/python
    import schedule
    import time
    import os

    while not os.path.exists('/var/run/postgresql/.s.PGSQL.5432'):
      time.sleep(1)

    os.system('pgbackrest --stanza=database --log-level-console=info stanza-create')

    def job():
      os.system('pgbackrest --stanza=database --log-level-console=info backup')
    schedule.every(1).hours.do(job)

    while True:
      schedule.run_pending()
      time.sleep(1)
